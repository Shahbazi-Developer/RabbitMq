@page
@model WarehouseMobile.Pages.IndexModel
@{
    ViewData["Title"] = "WarehouseMobile from RabbitMQ";
}

<link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet" />

<style>
    body {
        font-family: 'Vazirmatn', Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f3f7;
        color: #222;
        direction: rtl;
        padding: 30px 15px;
        margin: 0;
    }

    h2 {
        text-align: center;
        margin-bottom: 40px;
        font-weight: 800;
        font-size: 2.2rem;
        color: #2c3e50;
        letter-spacing: 1.2px;
        text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .filter-form {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: center;
        max-width: 1000px;
        margin-inline: auto;
    }

    .filter-form .input {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
    }

    .filter-form .btn {
        padding: 8px 16px;
        background-color: #4a90e2;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
    }

    .filter-form .btn:hover {
        background-color: #357ABD;
    }

    .filter-summary {
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;
        color: #444;
        font-size: 1.1rem;
    }

    table {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        border-collapse: separate;
        border-spacing: 0 12px;
        background: transparent;
    }

    thead tr {
        background: linear-gradient(90deg, #4a90e2, #357ABD);
        color: white;
        font-weight: 700;
        font-size: 1.05rem;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(53,122,189,0.3);
    }

    thead th {
        padding: 15px 20px;
        text-align: right;
        border-radius: 12px;
    }

    tbody tr {
        background: white;
        box-shadow: 0 3px 8px rgba(0,0,0,0.07);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        border-radius: 10px;
    }

    tbody tr:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 20px rgba(0,0,0,0.15);
    }

    tbody td {
        padding: 18px 20px;
        text-align: right;
        font-size: 1rem;
        color: #444;
        border-right: 1px solid #e0e0e0;
    }

    tbody td:last-child {
        border-right: none;
    }
</style>

<h2>📦 اطلاعات انبار کتاب</h2>

<form method="get" class="filter-form">
    <input type="text" name="SearchTerm" id="searchBox" placeholder="🔍 جستجو عنوان یا نویسنده"
           value="@Model.SearchTerm" class="input" />
    <input type="date" name="FromDate" value="@(Model.FromDate?.ToString("yyyy-MM-dd"))" class="input" />
    <input type="date" name="ToDate" value="@(Model.ToDate?.ToString("yyyy-MM-dd"))" class="input" />
    
</form>

@if (Model.FromDate.HasValue || Model.ToDate.HasValue)
{
    <div class="filter-summary">
        @if (Model.FromDate.HasValue)
        {
            <span>از تاریخ @Model.FromDate.Value.ToString("yyyy/MM/dd") </span>
        }
        @if (Model.ToDate.HasValue)
        {
            <span>تا تاریخ @Model.ToDate.Value.ToString("yyyy/MM/dd")</span>
        }
    </div>
}

<table>
    <thead>
        <tr>
            <th>📚 شناسه کتاب</th>
            <th>📘 عنوان</th>
            <th>✍️ نویسنده</th>
            <th>🕒 تاریخ ثبت</th>
        </tr>
    </thead>
    <tbody id="warehouseTableBody">
        @foreach (var warehouseMobile in Model.Warehouses)
        {
            <tr>
                <td>@warehouseMobile.BookId</td>
                <td>@warehouseMobile.Title</td>
                <td>@warehouseMobile.Author</td>
                <td>@warehouseMobile.CreationDate.ToString("yyyy/MM/dd HH:mm")</td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/warehouseMobileHub")
            .build();

        connection.on("ReceiveWarehouseMobile", function (warehouseMobile) {
            const table = document.getElementById("warehouseTableBody");
            const row = document.createElement("tr");

            row.innerHTML = `
                <td>${warehouseMobile.bookId}</td>
                <td>${warehouseMobile.title}</td>
                <td>${warehouseMobile.author}</td>
                <td>${new Date(warehouseMobile.creationDate).toLocaleString()}</td>
            `;

            table.prepend(row);
        });

        connection.start().catch(err => console.error(err));

        // جستجوی خودکار هنگام تایپ در فیلد جستجو
        const searchBox = document.getElementById('searchBox');
        let timer;
        searchBox.addEventListener('input', function () {
            clearTimeout(timer);
            timer = setTimeout(() => {
                const url = new URL(window.location.href);
                const search = searchBox.value.trim();
                if (search !== '') {
                    url.searchParams.set('SearchTerm', search);
                } else {
                    url.searchParams.delete('SearchTerm');
                }
                window.location.href = url.toString();
            }, 600);
        });
    </script>
}
